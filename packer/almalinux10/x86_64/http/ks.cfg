# AlmaLinux 10 Kickstart Configuration
# Minimal server installation for Packer builds

# Installation mode - cmdline for fully automated install
cmdline
eula --agreed

# Use network installation
url --url="https://repo.almalinux.org/almalinux/10.1/BaseOS/x86_64/os/"

# Keyboard and language
keyboard --xlayouts='us'
lang en_US.UTF-8

# Network configuration
network --bootproto=dhcp --device=link --activate
network --hostname=almalinux10

# Root password (change in production!)
rootpw --plaintext packer

# Create a default user
user --name=admin --groups=wheel --plaintext --password=admin

# Timezone
timezone UTC --utc

# Disable firewall for packer builds (enable in production)
firewall --disabled

# SELinux
selinux --enforcing

# Partitioning
ignoredisk --only-use=vda
clearpart --all --initlabel --drives=vda
autopart --type=lvm --nohome

# Bootloader
bootloader --append="console=tty0 console=ttyS0,115200n8" --location=mbr --boot-drive=vda

# Don't run the Setup Agent on first boot
firstboot --disabled

# Reboot after installation
reboot --eject

# Packages
%packages --ignoremissing
@^minimal-environment
# Essential utilities
bash-completion
vim-enhanced
wget
curl
tar
bzip2
rsync
# Hardware/cloud support
qemu-guest-agent
# Networking
NetworkManager
openssh-server
openssh-clients
# Exclude unnecessary firmware
-iwl*
-ivtv*
-aic*
-alsa*
%end

# Post-installation script
%post --log=/root/ks-post.log

# Enable serial console
systemctl enable serial-getty@ttyS0.service

# Enable QEMU guest agent
systemctl enable qemu-guest-agent

# Enable SSH
systemctl enable sshd

# Permit root login via SSH (for packer provisioning)
sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/^PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config

# Passwordless sudo for wheel group
echo '%wheel ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/wheel
chmod 440 /etc/sudoers.d/wheel

# Update all packages
dnf -y update

# Clean up
dnf clean all
rm -rf /var/cache/dnf/*
rm -rf /tmp/*

%end
